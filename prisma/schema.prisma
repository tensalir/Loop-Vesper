generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model bookmarks {
  id         String   @id @db.Uuid
  user_id    String   @db.Uuid
  output_id  String   @db.Uuid
  created_at DateTime @default(now())
  outputs    outputs  @relation(fields: [output_id], references: [id], onDelete: Cascade)
  profiles   profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, output_id])
  @@index([output_id])
  @@index([user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model generation_jobs {
  id            String      @id @db.Uuid
  generation_id String      @unique @db.Uuid
  run_after     DateTime?
  attempts      Int         @default(0)
  locked_at     DateTime?
  created_at    DateTime    @default(now())
  generations   generations @relation(fields: [generation_id], references: [id], onDelete: Cascade)

  @@index([locked_at])
  @@index([run_after])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model generations {
  id              String           @id @db.Uuid
  session_id      String           @db.Uuid
  user_id         String           @db.Uuid
  model_id        String
  prompt          String
  negative_prompt String?
  parameters      Json
  status          String
  created_at      DateTime         @default(now())
  cost            Decimal?         @db.Decimal(10, 6)
  generation_jobs generation_jobs?
  sessions        sessions         @relation(fields: [session_id], references: [id], onDelete: Cascade)
  profiles        profiles         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  outputs         outputs[]

  @@index([session_id])
  @@index([session_id, status])
  @@index([session_id, user_id])
  @@index([user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model models {
  id              String            @id
  name            String
  provider        String
  type            String[]
  config          Json
  is_active       Boolean           @default(true)
  created_at      DateTime          @default(now())
  user_model_pins user_model_pins[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model notes {
  id         String   @id @db.Uuid
  user_id    String   @db.Uuid
  output_id  String   @db.Uuid
  text       String
  context    String?
  created_at DateTime @default(now())
  updated_at DateTime
  outputs    outputs  @relation(fields: [output_id], references: [id], onDelete: Cascade)
  profiles   profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([output_id], map: "idx_notes_output_id")
  @@index([user_id], map: "idx_notes_user_id")
  @@index([output_id])
  @@index([user_id])
}

model output_analyses {
  id             String    @id @db.Uuid
  output_id      String    @unique @db.Uuid
  status         String    @default("queued")
  attempts       Int       @default(0)
  locked_at      DateTime?
  run_after      DateTime?
  error          String?
  gemini_caption String?
  gemini_model   String?
  claude_parsed  Json?
  claude_model   String?
  created_at     DateTime  @default(now())
  updated_at     DateTime
  completed_at   DateTime?
  outputs        outputs   @relation(fields: [output_id], references: [id], onDelete: Cascade)

  @@index([status, locked_at])
  @@index([status, run_after])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model outputs {
  id              String           @id @db.Uuid
  generation_id   String           @db.Uuid
  file_url        String
  file_type       String
  width           Int?
  height          Int?
  duration        Float?
  is_starred      Boolean          @default(false)
  created_at      DateTime         @default(now())
  is_approved     Boolean          @default(false)
  bookmarks       bookmarks[]
  notes           notes[]
  output_analyses output_analyses?
  generations     generations      @relation(fields: [generation_id], references: [id], onDelete: Cascade)

  @@index([generation_id, file_type])
  @@index([generation_id])
}

model product_renders {
  id           String   @id @db.Uuid
  name         String
  colorway     String?
  image_url    String
  storage_path String?
  source       String   @default("local")
  frontify_id  String?
  created_at   DateTime @default(now())
  updated_at   DateTime
  angle        String?
  sort_order   Int      @default(0)

  @@index([name, colorway])
  @@index([name])
  @@index([source])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model profiles {
  id              String            @id @db.Uuid
  username        String?           @unique
  display_name    String?
  avatar_url      String?
  created_at      DateTime          @default(now())
  updated_at      DateTime
  role            UserRole          @default(user)
  bookmarks       bookmarks[]
  generations     generations[]
  notes           notes[]
  project_chats   project_chats[]
  project_members project_members[]
  projects        projects[]
  user_model_pins user_model_pins[]
  workflows       workflows[]
}

model project_chat_messages {
  id            String        @id @db.Uuid
  chat_id       String        @db.Uuid
  role          String
  content       String
  created_at    DateTime      @default(now())
  project_chats project_chats @relation(fields: [chat_id], references: [id], onDelete: Cascade)

  @@index([chat_id])
}

model project_chats {
  id                    String                  @id @db.Uuid
  project_id            String                  @db.Uuid
  user_id               String                  @db.Uuid
  title                 String                  @default("New Chat")
  created_at            DateTime                @default(now())
  updated_at            DateTime
  project_chat_messages project_chat_messages[]
  projects              projects                @relation(fields: [project_id], references: [id], onDelete: Cascade)
  profiles              profiles                @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([project_id, user_id])
  @@index([user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model project_members {
  id         String   @id @db.Uuid
  project_id String   @db.Uuid
  user_id    String   @db.Uuid
  role       String
  joined_at  DateTime @default(now())
  projects   projects @relation(fields: [project_id], references: [id], onDelete: Cascade)
  profiles   profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
  @@index([project_id])
  @@index([user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model projects {
  id              String            @id @db.Uuid
  name            String
  description     String?
  cover_image_url String?
  owner_id        String            @db.Uuid
  is_shared       Boolean           @default(false)
  created_at      DateTime          @default(now())
  updated_at      DateTime
  briefing        String?
  project_chats   project_chats[]
  project_members project_members[]
  profiles        profiles          @relation(fields: [owner_id], references: [id], onDelete: Cascade)
  sessions        sessions[]

  @@index([is_shared, owner_id])
  @@index([owner_id])
  @@index([updated_at(sort: Desc), id(sort: Desc)])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model prompt_enhancement_prompts {
  id           String   @id @db.Uuid
  name         String
  description  String?
  systemPrompt String
  is_active    Boolean  @default(true)
  modelIds     String[]
  createdBy    String   @db.Uuid
  created_at   DateTime @default(now())
  updatedAt    DateTime
  updatedBy    String   @db.Uuid
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model sessions {
  id          String        @id @db.Uuid
  project_id  String        @db.Uuid
  name        String
  type        String
  created_at  DateTime      @default(now())
  updated_at  DateTime
  is_private  Boolean       @default(true)
  generations generations[]
  projects    projects      @relation(fields: [project_id], references: [id], onDelete: Cascade)

  @@index([project_id])
  @@index([project_id, is_private])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_model_pins {
  user_id   String   @db.Uuid
  model_id  String
  pin_order Int
  models    models   @relation(fields: [model_id], references: [id], onDelete: Cascade)
  profiles  profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, model_id])
  @@index([user_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model workflows {
  id            String   @id @db.Uuid
  user_id       String   @db.Uuid
  name          String
  description   String?
  is_template   Boolean  @default(false)
  workflow_data Json
  created_at    DateTime @default(now())
  updated_at    DateTime
  profiles      profiles @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

enum UserRole {
  admin
  user
}
